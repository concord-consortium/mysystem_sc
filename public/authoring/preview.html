<html>
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

  <title>MySystem Authoring</title>
  <!-- <link rel="stylesheet" href="css/style.css?v=2"> -->
  <link rel="stylesheet" href="css/jquery.gritter.css">
  <script type="text/javascript" src="js/libs/jquery-1.4.4.min.js"></script>
  <script type="text/javascript" src="js/libs/jquery.couch.js"></script>
  <script type="text/javascript" src="js/libs/jquery.gritter.min.js"></script>
  <script type="text/javascript" src="js/couch-ds.js"></script>
  <script type="text/javascript">
    $(document).ready(function() {  

      var initialData = {
        modules:[],
        energy_types:[],
        diagram_rules:[],
        maxFeedbackItems: 0,
        enableNodeDescriptionEditing: false,
        enableLinkDescriptionEditing: false,
        enableLinkLabelEditing: false
      };

      var authorIframeId = 'mysystem2-authoring-iframe',
          appIframeId = 'runtime-iframe',
          authorIframeLoaded = false,
          appIframeLoaded = false;
      
      function createIframe(url, id, $elem, callback) {
        $iframe = $('<iframe id='+id+'>').attr('src', url).attr('width', '100%').attr('height', 600);
        $elem.append($iframe);
        $('iframe#'+id).load(function() 
        {
          callback(this);
        });
      }
      
      function updateRuntime(data) {
        if (!data.modules){
          authoring_iframe = document.getElementById(authorIframeId).contentWindow;
          var data = authoring_iframe.MSA.data;
        }
        var runtime_iframe = document.getElementById('runtime-iframe').contentWindow;
        var activity = runtime_iframe.MySystem.Activity.fromWiseStepDef(data);
        runtime_iframe.SC.RunLoop.begin();
          runtime_iframe.MySystem.activityController.set('content',activity);
        runtime_iframe.SC.RunLoop.end();
      }
      
      createIframe('index.html', authorIframeId, $('#authoring_td'), function(iframe){
        iframe.contentWindow.MSA.setupParentIFrame(initialData, this, updateRuntime);
        authorIframeLoaded = true;
        if (authorIframeLoaded && appIframeLoaded){
          bothIframesLoaded();
        }
      });
      
      createIframe('../my_system', 'runtime-iframe', $('#runtime_td'), function(iframe){
        updateRuntime(initialData);
        appIframeLoaded = true;
        if (authorIframeLoaded && appIframeLoaded){
          bothIframesLoaded();
        }
      });
    });
   
    function bothIframesLoaded() {
      var dataStore = new msaPreview.CouchDS(),
          authorContent = document.getElementById('mysystem2-authoring-iframe').contentWindow,
          runtimeContent = document.getElementById('runtime-iframe').contentWindow;
      // console.log()
      dataStore.setAuthorContentWindow(authorContent);
      dataStore.setLearnerContentWindow(runtimeContent);

      var dataIds = window.location.hash;
      if (dataIds) {
        dataIds = dataIds.substring(1);    // rm hash
        var data = dataIds.split("/");
        if (!!data[0]){
          dataStore.loadAuthoredData(data[0]);
        }
        if (data.length > 1 && !!data[1]){
          dataStore.loadLearnerData(data[1]);
        }
      }
      
      
      $('#save_authoring').click(function(){dataStore.saveAuthoring()});
      runtimeContent.MySystem.registerExternalSaveFunction(dataStore.saveLearner, dataStore);
      
   }

   
  </script>
</head>
<body>
  <h1>MySystem Authoring Preview</h1>
  <table width="100%">
    <tr>
      <td width="50%" id="authoring_td">
        <button id="save_authoring">Save authored activity</button>
      </td>
      <td width="50%" id="runtime_td" style="text-align: right">
      </td>
    </tr>
  </table>
</body>
</html>
